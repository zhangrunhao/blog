# Web项目离线加载方案概要(第一版)

## 现状与概述

* Web项目中含有大量静态资源, 每次在线加载时间较长

## 方案概要

### 主流程概要

* ![主流程概要示意图](https://zhangrunhao.oss-cn-beijing.aliyuncs.com/blog/work/Web%E9%A1%B9%E7%9B%AE%E7%A6%BB%E7%BA%BF%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B.jpg)
* 从输入URL开始
* 首先判断是否为离线项目(使用协议进行判断)
* 是离线项目, 则检查本地是否以离线该项目.
* 未离线该项目, 则下载项目, 并通过资源访问模块取出资源, 进行渲染展示

### 各功能模块概要

* ![各个功能模块示意图](https://zhangrunhao.oss-cn-beijing.aliyuncs.com/blog/work/%E5%90%84%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B%20%281%29.jpg)
* 资源代理模块
  * 输入访问的url
  * 进行本地项目和其他类型项目文件的访问
  * 返回输入结果
* 下载/更新资源模块
  * 输入离线项目id等参数
  * 对比版本号
  * 检查本地是否存在该离线项目
  * 下载解压离线包
  * 返回下载解压结果
* 调度者模块
  * 管理离线项目版本与地址
  * 读取各项目配置
  * 决定更新策略与时机
  * 调用各个功能模块

### 更新流程概要

* ![下载更新流程示意图](https://zhangrunhao.oss-cn-beijing.aliyuncs.com/blog/work/%E8%B5%84%E6%BA%90%E4%B8%8B%E8%BD%BD_%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B.jpg)
* 开始进入下载更新流程
* 检查本地是否已离线该项目
* 本地存在该项目, 获取线上版本号
* 对比版本号, 发现不同, 下载线上版本
* 解压离线包, 并返回本地地址

### 更新策略(后续版本可逐渐增加其他策略)

* ![前置更新示意图](https://zhangrunhao.oss-cn-beijing.aliyuncs.com/blog/work/%E5%89%8D%E7%BD%AE%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B%E7%A4%BA%E6%84%8F%E5%9B%BE.jpg)
* 确认本地存在离线项目后, 已不阻塞项目打开运行的方式, 检测版本
* 使用更新流程, 在更新结束后, 存储当前新的地址

### 清除机制

* 单个项目可灵活设置过期时间, 清理本地文件
* 整体项目根据离线包总大小进行清理早期文件

## 总结

### 初版需要完成

* 完成上传单个离线项目包与该项目配置信息
* 完成该离线项目正常下载安装
* 可动态更新单个项目
* 访问离线项目资源试, 拦截请求, 并返回本地资源

### 后期预期

* 使用差量包减少单个项目包更新大小
* 添加不同更新策略
* 引入插件模式, 提高重复资源利用率
* 增加重试机制
* 优化清楚机制, 保证资源使用率
* 保留前版本, 提供快速回滚
* 等等
